<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EmojiPick — Compare</title>
  <link rel="stylesheet" href="styles.v11.css" />
  <style>
    .pageWrap{max-width:980px;margin:22px auto;padding:0 16px;}
    .headerRow{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:14px;}
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{width:28px;height:28px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:#F3F4F6;}
    .brandTitle{font-weight:800;}
    .brandSub{font-size:12px;opacity:.7;margin-top:2px;}
    .btn{appearance:none;border:1px solid #CBD5E1;background:white;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer;}
    .btnPrimary{background:#111827;color:white;border-color:#111827;}
    .card{border:1px solid #E5E7EB;border-radius:16px;padding:16px;background:white;box-shadow:0 8px 22px rgba(0,0,0,.05);}
    .card + .card{margin-top:14px;}
    h1{font-size:22px;margin:0 0 8px 0;}
    .hint{font-size:13px;opacity:.75;margin-top:4px;}
    label{display:block;font-weight:700;margin:10px 0 6px;}
    input,select{width:100%;padding:10px 12px;border:1px solid #D1D5DB;border-radius:12px;}
    .row{display:grid;grid-template-columns:1fr 240px;gap:14px;align-items:end;}
    @media (max-width:720px){.row{grid-template-columns:1fr;}}
    .results{margin-top:12px;padding:12px;border-radius:12px;background:#F8FAFC;border:1px solid #E2E8F0;}
    .pillRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
    .pill{display:inline-flex;align-items:center;justify-content:center;min-width:38px;padding:6px 10px;border:1px solid #E5E7EB;border-radius:999px;background:white;font-weight:800;}
    .pill.hit{border-color:#22C55E;}
    .pill.miss{opacity:.6;}
    .footerLinks{display:flex;gap:12px;justify-content:space-between;margin-top:18px;font-size:13px;}
    .footerLinks a{color:#2563EB;}
  </style>
</head>
<body>
  <div class="pageWrap">
    <div class="headerRow">
      <div class="brand">
        <div class="logo">✨</div>
        <div>
          <div class="brandTitle">EmojiPick</div>
          <div class="brandSub">Check matches vs winning numbers</div>
        </div>
      </div>
      <button class="btn" onclick="location.href='index.html'">Back</button>
    </div>

    <div class="card">
      <div class="hint">Steps: choose a saved pick → enter winning numbers → compare.</div>
      <h1>1) Choose a saved pick</h1>
      <select id="pickSelect"></select>
      <div class="hint" id="noPicksHint" style="display:none;margin-top:10px;">No saved picks yet. Go back, generate numbers, and click <b>Save</b>.</div>
    </div>

    <div class="card">
      <h1>2) Winning numbers</h1>
      <div class="hint" id="autoHint">We auto-fill the latest published winning numbers for this game. (You can optionally edit.)</div>

      <div class="results" id="latestBox" style="display:block;margin-top:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
          <div>
            <div style="font-weight:800;">Latest winning numbers</div>
            <div class="hint" id="latestMeta">Loading…</div>
          </div>
          <button class="btn" id="refreshLatest" type="button">Refresh</button>
        </div>
        <div class="pillRow" id="latestPills" style="margin-top:10px;"></div>
      </div>

      <div style="margin-top:12px;display:flex;align-items:center;gap:10px;">
        <input id="manualToggle" type="checkbox" style="width:auto;" />
        <label for="manualToggle" style="margin:0;font-weight:700;">Edit winning numbers manually</label>
      </div>

      <div class="row" id="manualRow" style="margin-top:8px;opacity:.65;pointer-events:none;">
        <div style="flex:2;min-width:240px;">
          <label for="winMain">Main numbers</label>
          <input id="winMain" class="input" placeholder="Auto-filled" inputmode="numeric" />
          <div class="hint">Format examples: <b>1 2 3 4 5</b>, or <b>1,2,3,4,5</b></div>
        </div>
        <div style="flex:1;min-width:180px;">
          <label for="winBonus" id="bonusLabel">Bonus (optional)</label>
          <input id="winBonus" class="input" placeholder="Auto-filled" inputmode="numeric" />
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn btnPrimary" id="compareBtn">Compare</button>
        <button class="btn" id="clearBtn" type="button">Clear</button>
      </div>

      <div class="results" id="results" style="display:none;"></div>

      <div class="results" id="hotBox" style="display:block;margin-top:14px;">
        <div style="font-weight:800;">Hot numbers (historical)</div>
        <div class="hint" id="hotMeta">Loading…</div>
        <div class="pillRow" id="hotPills" style="margin-top:10px;"></div>
        <div class="hint" id="hotMatchHint" style="margin-top:8px;"></div>
      </div>
    </div>

    <div class="footerLinks">
      <div>
        <a href="privacy.html">Privacy policy</a>
        &nbsp;&nbsp;
        <a href="terms.html">Terms and Conditions</a>
      </div>
      <div>Build v21</div>
    </div>
  </div>

<script>
(()=>{
  const LS_KEY = 'emojipick_picks_v1';

  const GAME = {
    pb: { name: 'Powerball', mainCount: 5, bonusLabel: 'Powerball', dataKey: 'powerball' },
    mm: { name: 'Mega Millions', mainCount: 5, bonusLabel: 'Mega Ball', dataKey: 'megamillions' },
    tx: { name: 'TX Instant (Demo)', mainCount: 5, bonusLabel: null, dataKey: null }
  };

  // Elements
  const pickSelect = document.getElementById('pickSelect');
  const winMainInput = document.getElementById('winMain');
  const winBonusInput = document.getElementById('winBonus');
  const compareBtn = document.getElementById('compareBtn');
  const clearBtn = document.getElementById('clearBtn');
  const results = document.getElementById('results');

  const latestMeta = document.getElementById('latestMeta');
  const latestPills = document.getElementById('latestPills');
  const refreshLatestBtn = document.getElementById('refreshLatest');

  const manualToggle = document.getElementById('manualToggle');
  const manualRow = document.getElementById('manualRow');

  const hotMeta = document.getElementById('hotMeta');
  const hotPills = document.getElementById('hotPills');
  const hotMatchHint = document.getElementById('hotMatchHint');

  let picks = [];
  let currentPick = null;
  let currentWinning = null;
  let currentStats = null;

  // Helpers
  const safeJsonParse = (s, fallback) => {
    try { return JSON.parse(s); } catch { return fallback; }
  };

  const fmtDate = (iso) => {
    if(!iso) return '';
    const d = new Date(iso + 'T00:00:00');
    if (Number.isNaN(d.getTime())) return iso;
    return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' });
  };

  const pill = (text, isBonus=false, isHit=false) => {
    const span = document.createElement('span');
    span.className = 'pill' + (isBonus ? ' pillBonus' : '') + (isHit ? ' pillHit' : '');
    span.textContent = String(text);
    return span;
  };

  const setManualEnabled = (enabled) => {
    manualRow.style.opacity = enabled ? '1' : '.65';
    manualRow.style.pointerEvents = enabled ? 'auto' : 'none';
    winMainInput.readOnly = !enabled;
    winBonusInput.readOnly = !enabled;
  };

  const getGame = (code) => GAME[code] || { name: code, mainCount: 5, bonusLabel: null, dataKey: null };
  const normalizePick = (raw) => {
    if (!raw || typeof raw !== 'object') return null;

    // game id
    const game = raw.game || raw.gameId || raw.g || 'pb';

    // date
    const date = (raw.date || raw.dateSeed || raw.d || '').toString();

    // emojis
    const emojis = Array.isArray(raw.emojis) ? raw.emojis
      : Array.isArray(raw.e) ? raw.e
      : [];

    // main numbers
    let numbers = [];
    if (Array.isArray(raw.numbers)) numbers = raw.numbers.slice();
    else if (Array.isArray(raw.nums)) numbers = raw.nums.slice();
    else if (raw.nums && Array.isArray(raw.nums.main)) numbers = raw.nums.main.slice();
    else if (raw.nums && Array.isArray(raw.nums.numbers)) numbers = raw.nums.numbers.slice();

    // bonus number (powerball / mega ball / etc.)
    let bonus = (raw.powerball ?? raw.pb ?? raw.bonus ?? raw.power ?? null);
    if (bonus == null && raw.nums && typeof raw.nums.bonus === 'number') bonus = raw.nums.bonus;
    if (bonus == null && raw.nums && Array.isArray(raw.nums.bonus) && raw.nums.bonus.length) bonus = raw.nums.bonus[0];

    // If legacy stored all 6 in numbers for PB/MM, split last as bonus
    const g = getGame(game);
    const expectsBonus = !!g.bonusLabel;
    if (bonus == null && expectsBonus && numbers.length === 6) {
      bonus = numbers[5];
      numbers = numbers.slice(0, 5);
    }

    // created/saved time for sorting
    const savedAt = raw.savedAt || raw.createdAt || raw.ts || raw.time || 0;

    return { ...raw, game, date, emojis, numbers, bonus, savedAt };
  };

  const sortKey = (p) => {
    const d = (p.date || '').replace(/[^0-9]/g, '').padEnd(8, '0');
    const t = String(p.savedAt || 0).padStart(13, '0');
    return d + '-' + t;
  };


  const readPicks = () => {
    const raw = safeJsonParse(localStorage.getItem(LS_KEY), []);
    const arr = Array.isArray(raw) ? raw : [];
    const picks = arr.map((p, idx) => {
      const norm = normalizePick(p);
      if (!norm) return null;
      norm.__idx = idx;
      return norm;
    }).filter(p => p && p.numbers && p.numbers.length);

    // newest first
    picks.sort((a, b) => sortKey(b).localeCompare(sortKey(a)));
    return picks;
  };

  const writePicks = (arr) => {
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
  };

  const sortPicksDesc = (arr) => {
    // Newest first: by createdAt (if exists), else by date string
    return [...arr].sort((a,b)=>{
      const ta = a.createdAt ? Date.parse(a.createdAt) : Date.parse((a.date||'')+'T00:00:00');
      const tb = b.createdAt ? Date.parse(b.createdAt) : Date.parse((b.date||'')+'T00:00:00');
      return (tb||0) - (ta||0);
    });
  };

  const optionLabel = (p) => {
    const g = getGame(p.game);
    const emojis = (p.emojis || []).join(' ');
    const main = (p.numbers || []).join('-');
    const bonus = (p.powerball ?? p.bonus ?? p.pb);
    const bonusText = (bonus !== undefined && bonus !== null && bonus !== '')
      ? ` + ${g.bonusLabel || 'Bonus'} ${bonus}`
      : '';
    return `${g.name} • ${p.date || ''} • ${emojis} • ${main}${bonusText}`.replace(/\s+/g,' ').trim();
  };

  const renderPickDropdown = () => {
    pickSelect.innerHTML = '';

    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = 'Pick…';
    pickSelect.appendChild(ph);

    picks.forEach((p, idx) => {
      const opt = document.createElement('option');
      opt.value = String(idx);
      opt.textContent = optionLabel(p);
      pickSelect.appendChild(opt);
    });
  };

  // Data: latest winning numbers + stats (bundled JSON)
  const fetchJson = async (url) => {
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  };

  const loadLatestForGame = async (gameCode) => {
    const g = getGame(gameCode);
    if(!g.dataKey) return null;
    return await fetchJson(`./data/${g.dataKey}_latest.json`);
  };

  const loadStatsForGame = async (gameCode) => {
    const g = getGame(gameCode);
    if(!g.dataKey) return null;
    return await fetchJson(`./data/${g.dataKey}_stats.json`);
  };

  const renderLatest = (w, gameCode) => {
    latestPills.innerHTML = '';
    const g = getGame(gameCode);

    if(!w){
      latestMeta.textContent = 'No auto data available yet for this game.';
      return;
    }

    latestMeta.textContent = `${g.name} • Draw: ${fmtDate(w.draw_date)} • Source: ${w.source || 'bundled'}`;

    (w.main_numbers || []).forEach(n => latestPills.appendChild(pill(n)));
    if(w.bonus_number !== undefined && w.bonus_number !== null && w.bonus_number !== ''){
      latestPills.appendChild(pill(`${w.bonus_label || g.bonusLabel || 'Bonus'} ${w.bonus_number}`, true));
    }
  };

  const renderStats = (stats, gameCode) => {
    hotPills.innerHTML = '';
    hotMatchHint.textContent = '';

    if(!stats){
      hotMeta.textContent = 'No stats available yet.';
      return;
    }

    hotMeta.textContent = `Top frequent numbers (${stats.window || 'history'}).`;

    const hotMain = (stats.hot_main || []).slice(0, 10);
    const hotBonus = (stats.hot_bonus || []).slice(0, 5);

    const pickMain = new Set((currentPick?.numbers || []).map(Number));
    hotMain.forEach(n => {
      const isHit = pickMain.has(Number(n));
      hotPills.appendChild(pill(n, false, isHit));
    });

    if(hotBonus.length){
      const bonus = currentPick?.powerball ?? currentPick?.bonus ?? currentPick?.pb;
      hotPills.appendChild(pill('—', true, false));
      hotBonus.forEach(n => {
        const isHit = (bonus !== undefined && bonus !== null) ? Number(bonus) == Number(n) : false;
        hotPills.appendChild(pill(`${getGame(gameCode).bonusLabel || 'Bonus'} ${n}`, true, isHit));
      });
    }

    if(currentPick){
      const matches = hotMain.filter(n => (currentPick.numbers||[]).map(Number).includes(Number(n)));
      if(matches.length){
        hotMatchHint.textContent = `Your pick shares ${matches.length} hot number(s): ${matches.join(', ')}`;
      } else {
        hotMatchHint.textContent = 'Your pick shares no hot main numbers (in this demo list).';
      }
    }
  };

  const fillWinningInputs = (w, gameCode) => {
    const g = getGame(gameCode);
    if(!w){
      winMainInput.value = '';
      winBonusInput.value = '';
      winBonusInput.placeholder = g.bonusLabel ? `e.g., 6` : '';
      return;
    }
    winMainInput.value = (w.main_numbers || []).join(' ');
    winBonusInput.value = (w.bonus_number !== undefined && w.bonus_number !== null) ? String(w.bonus_number) : '';
    winBonusInput.placeholder = g.bonusLabel ? `e.g., ${w.bonus_number || 6}` : '';
  };

  const parseNums = (s) => {
    if(!s) return [];
    return s
      .replace(/[^0-9,\s]+/g,' ')
      .split(/[\s,]+/)
      .filter(Boolean)
      .map(x => parseInt(x, 10))
      .filter(n => Number.isFinite(n));
  };

  const doCompare = () => {
    if(!currentPick){
      results.style.display = 'block';
      results.innerHTML = '<strong>Please choose a saved pick first.</strong>';
      return;
    }

    const gameCode = currentPick.game;
    const g = getGame(gameCode);

    const winMain = parseNums(winMainInput.value);
    const winBonus = parseNums(winBonusInput.value)[0];

    if(winMain.length !== g.mainCount){
      results.style.display = 'block';
      results.innerHTML = `<strong>Winning main numbers must contain exactly ${g.mainCount} numbers.</strong>`;
      return;
    }

    const pickMain = (currentPick.numbers || []).map(Number);
    const pickBonus = currentPick.powerball ?? currentPick.bonus ?? currentPick.pb;

    const mainMatches = pickMain.filter(n => winMain.includes(Number(n)));
    const bonusMatch = (pickBonus !== undefined && pickBonus !== null && pickBonus !== '')
      ? (Number(pickBonus) === Number(winBonus))
      : false;

    results.style.display = 'block';
    results.innerHTML = `
      <div style="font-weight:800;">Match result</div>
      <div class="hint">Pick: ${pickMain.join(' ')}${(pickBonus!==undefined && pickBonus!==null && pickBonus!=='') ? ` + ${g.bonusLabel||'Bonus'} ${pickBonus}` : ''}</div>
      <div class="hint">Winning: ${winMain.join(' ')}${(winBonus!==undefined && winBonus!==null && winBonus!=='') ? ` + ${g.bonusLabel||'Bonus'} ${winBonus}` : ''}</div>
      <div style="margin-top:10px;">Main matches: <strong>${mainMatches.length}</strong> ${mainMatches.length ? `(${mainMatches.join(', ')})` : ''}</div>
      <div>Bonus match: <strong>${bonusMatch ? 'Yes' : 'No'}</strong></div>
      <div class="hint" style="margin-top:8px;">For fun only — no prediction or improved odds.</div>
    `;
  };

  const refreshAutoData = async () => {
    if(!currentPick){
      renderLatest(null, 'pb');
      return;
    }

    const gameCode = currentPick.game;

    try{
      currentWinning = await loadLatestForGame(gameCode);
    }catch(e){
      currentWinning = null;
    }

    try{
      currentStats = await loadStatsForGame(gameCode);
    }catch(e){
      currentStats = null;
    }

    renderLatest(currentWinning, gameCode);
    fillWinningInputs(currentWinning, gameCode);
    renderStats(currentStats, gameCode);

    // Auto-compare when auto data is present
    if(currentWinning){
      doCompare();
    }
  };

  const onPickChanged = async () => {
    const idx = parseInt(pickSelect.value, 10);
    currentPick = Number.isFinite(idx) ? sortPicksDesc(picks)[idx] : null;

    results.style.display = 'none';

    await refreshAutoData();
  };

  // Events
  manualToggle.addEventListener('change', () => {
    setManualEnabled(manualToggle.checked);
  });

  refreshLatestBtn.addEventListener('click', async () => {
    await refreshAutoData();
  });

  pickSelect.addEventListener('change', onPickChanged);

  compareBtn.addEventListener('click', () => {
    doCompare();
  });

  clearBtn.addEventListener('click', () => {
    winMainInput.value = '';
    winBonusInput.value = '';
    results.style.display = 'none';
  });

  // Init
  picks = readPicks();
  renderPickDropdown();
  setManualEnabled(false);

  // Auto-select the first (newest) pick if exists
  if(picks.length){
    pickSelect.value = '0';
    onPickChanged();
  } else {
    renderLatest(null, 'pb');
    renderStats(null, 'pb');
  }
})();

</script>
</body>
</html>
